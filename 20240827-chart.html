<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>chartjs</title>
        <link rel="stylesheet" href="css/bootstrap.min.css" />
        <link rel="stylesheet" href="css/all.min.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <link rel="stylesheet" href="css/MarkerCluster.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
        <link rel="stylesheet" href="css/myall.css" />
        <link rel="icon" href="images/bunny/logo10.png" type="image/x-icon" />
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
              <a class="navbar-brand" href="#">控制台</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                  <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="20240730-spa.html">Home</a>
                  </li>
                  <li class="nav-item"></li>
                    <a class="nav-link active" href="20240827-chart.html">Chart分析</a>
                  </li>
                  
                </ul>
                <div>
                    <span class="h3 text-success fw-900">會員: <span class="h2 text-danger fw-900" id="s02_login_username">XXX</span> </span>
                    <button class="btn btn-primary d-none" id="s02_logout_btn">登出</button>
                </div>
              </div>
            </div>
          </nav>
        <div class="container my-4">
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="display-3 fw-900">會員人數</div>
                            <div
                                class="display-2 text-danger fw-900 text-center"
                            id="memberNum">
                                99
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="display-3 fw-900">金牌會員</div>
                            <div
                                class="display-2 text-danger fw-900 text-center"
                                id="levelgold"
                            >
                                99
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-center mt-4">
                <div class="col-7">
                    <div class="card h-100">
                        <div class="card-body">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-5">
                    <div class="card h-100">
                        <div class="card-body">
                            <canvas id="myChart01"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <canvas id="myChart02"></canvas>
                </div>
            </div>
        </div>
        <script src="js/bootstrap.bundle.min.js"></script>
        <script src="js/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            var mychart;
            var mychart01;
            var mychart02;
            $(function () {
                // 取得資料
                $.ajax({
                    type: "GET",
                    url: "member-chart-level-api.php",
                    dataType: "json",
                    success: showdata_chart,
                    error: function () {
                        alert("error-member-chart-level-api.php");
                    },
                });

                $.ajax({
                    type: "GET",
                    url: "member-chart-state-api.php",
                    dataType: "json",
                    success: showdata_chart02,
                    error: function () {
                        alert("error-member-chart-state-api.php");
                    },
                });

                $.ajax({
                    type: "GET",
                    url: "member-chart-levelGold-api.php",
                    dataType: "json",
                    // async: false,
                    success: showdata_levelGold,
                    error: function () {
                        alert("error-member-chart-levelGold-api.php");
                    },
                });

                $.ajax({
                    type: "GET",
                    url: "member-chart-memberNum-api.php",
                    dataType: "json",
                    // async: false,
                    success: showdata_memberNum,
                    error: function () {
                        alert("error-member-chart-memberNum-api.php");
                    },
                });

                //myChart
                const ctx = document.getElementById("myChart"); 

                mychart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: [
                            "Red",
                            "Blue",
                            "Yellow",
                            "Green",
                            "Purple",
                            "Orange",
                        ],
                        datasets: [
                            {
                                label: "# of Votes", 
                                data: [12, 19, 3, 5, 2, 3], 
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                    },
                });

                //myChart01
                const ctx01 = document.getElementById("myChart01");

                mychart01 = new Chart(ctx01, {
                    type: "pie",
                    data: {
                        labels: [
                            "Red",
                            "Blue",
                            "Yellow",
                            "Green",
                            "Purple",
                            "Orange000",
                        ],
                        datasets: [
                            {
                                label: "# 圖表名稱",
                                data: [120, 19, 3, 5, 2, 30],
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                    },
                });

                //myChart02
                const ctx02 = document.getElementById("myChart02"); 

                mychart02 = new Chart(ctx02, {
                    type: "bar",
                    data: {
                        labels: [
                            "Red",
                            "Blue",
                            "Yellow",
                            "Green",
                            "Purple",
                            "Orange000",
                        ],
                        datasets: [
                            {
                                label: "# 圖表名稱",
                                data: [120, 19, 3, 5, 2, 30],
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                    },
                });

                

         
            if(getCookie("uid01") !=""){
              
                var dataJSON = {};
                dataJSON["uid01"] = getCookie("uid01");
                console.log(JSON.stringify(dataJSON)); 

                $.ajax({
                    type: "POST",
                    url: "member-login-check-uid-api.php",
                    data: JSON.stringify(dataJSON),
                    dataType: "json",
                    success: showdata_check_uid,
                    error: function () {
                        alert("error-member-login-check-uid-api.php");
                    }
                });         
                
            }else{
                alert("尚未登入，請登入會員來使用附加功能!"); 
                location.href = "20240730-spa.html" 
            }

    //**************** 登出按鈕監聽**********************
            $("#s02_logout_btn").click(function(){
                setCookie("uid01", "", 7);
                location.href = "20240730-spa.html";
            });

            
            
            }); 

            function showdata_chart(data) {
                console.log(data);

              
                mychart.data.labels = [];
                mychart.data.datasets[0].data = [];

                mychart01.data.labels = [];
                mychart01.data.datasets[0].data = [];

                data.data.forEach(function (item) {
                    console.log(item.Level);
                    console.log(item.level_num);
                    if (item.Level == 900) {
                        mylevel = "管理員";
                    } else if (item.Level == 100) {
                        mylevel = "一般會員";
                    } else if (item.Level == 200) {
                        mylevel = "高級會員";
                    } else if (item.Level == 300) {
                        mylevel = "銀牌會員";
                    } else if (item.Level == 400) {
                        mylevel = "金牌會員";
                    }
                    mychart.data.labels.push(mylevel);
                    mychart.data.datasets[0].data.push(item.level_num);
                    mychart.update();

                    mychart01.data.labels.push(mylevel);
                    mychart01.data.datasets[0].data.push(item.level_num);
                    mychart01.update();
                });
            }

            function showdata_chart02(data) {
                console.log(data);

                mychart02.data.labels = [];
                mychart02.data.datasets[0].data = [];

                data.data.forEach(function (item) {
                    console.log(item.State);
                    console.log(item.state_num);
                    if (item.State == 1) {
                        mystate = "啟用";
                    } else {
                        mystate = "停權";
                    }

                    mychart02.data.labels.push(mystate);
                    mychart02.data.datasets[0].data.push(item.state_num);
                    mychart02.update();
                });
            }


            function showdata_levelGold(data) {
                $("#levelgold").empty();
                console.log(data);
                console.log(data.data[0].level_gold);
                $("#levelgold").text(data.data[0].level_gold); 
            }

            function showdata_memberNum(data) {
                $("#memberNum").empty(); 
                console.log(data);
                console.log(data.data[0].member_num);
                $("#memberNum").text(data.data[0].member_num); 
            }


            function showdata_check_uid(data){
            console.log(data);
            
            if (data.state) {
                
                 $("#s02_login_username").text(data.data.Username);
               
                $("#s02_logout_btn").removeClass("d-none");
            }
        }

   
     
        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            let expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
                }
            }
        return "";
        }        
        </script>
    </body>
</html>
